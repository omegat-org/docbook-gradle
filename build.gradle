import org.omegat.documentation.DocbookHtml
import org.omegat.documentation.WhcTask
import org.omegat.documentation.StylesheetTask

plugins {
    id 'org.omegat.documentation'
}

repositories {
    mavenCentral()
}

def documentRootDir = file('src/docs')
def styleRootDir = file('src/docs/xsl')

docConfig {
    styleDir.set(styleRootDir)
    docRoot.set(documentRootDir)
    outputRoot.set(layout.buildDirectory.dir('docs/manual'))
}

tasks.register('manualZips') {
    description = 'Build ZIP manuals to bundle into application. Requires container runtime.'
    group = 'documentation'
}

tasks.register('manualHtmls') {
    description = 'Build HTML manuals and zip for all languages. Requires container runtime.'
    group = 'documentation'
}

def manualIndexXmls = fileTree(dir: 'src/docs', include: '**/OmegaTUsersManual_xinclude_full.xml')
manualIndexXmls.each { xml ->
    def lang = xml.parentFile.name
    def docbookInclude = tasks.register("docbookInclude${lang.capitalize()}", Exec) {
        executable('/usr/bin/xmllint')
        commandLine '/usr/bin/xmllint', '--xinclude', '-o', layout.buildDirectory.dir("docs/manual/${lang}/xhtml5/_index.xml").get().toString(),
                "${documentRootDir}/${lang}/OmegaTUsersManual_xinclude_full.xml"
        inputs.file file("${documentRootDir}/${lang}/OmegaTUsersManual_xinclude_full.xml")
        outputs.file file(layout.buildDirectory.dir("docs/manual/${lang}/xhtml5/_index.xml"))
    }

    def copyCss = tasks.register("copyCss${lang.capitalize()}", Copy) {
        description 'Copy Images and CSS file to target'
        into layout.buildDirectory.dir("docs/manual/${lang}")
        from new File(documentRootDir, 'omegat.css')
    }

    def copyImages = tasks.register("copyImages${lang.capitalize()}", Copy) {
        description 'Copy Images and CSS file to target'
        into layout.buildDirectory.dir("docs/manual/${lang}/images/")
        from new File(documentRootDir, "${lang}/images/")
    }

    def docbookHtml = tasks.register("docbookHtml${lang.capitalize()}", DocbookHtml) {
        description 'Generate chunked HTML documentation'
        language.set(lang)
        inputFile.set(outputRoot.get().file("${language.get()}/xhtml5/_index.xml"))
        mainOutputFile.set(outputRoot.get().file("${language.get()}/xhtml5/_index.html"))
        styleSheetFile.set(styleDir.file("xhtml.xsl"))
        inputs.dir(documentRootDir)
        outputs.files(outputRoot.get().file("${language.get()}/xhtml5/_index.html"))
        dependsOn(docbookInclude, copyImages, copyCss)
    }

    def whcToc = tasks.register("whcToc${lang.capitalize()}", StylesheetTask) {
        description 'Generate whc header and index'
        language.set(lang)
        styleSheetFile.set(styleDir.file('whc-toc.xsl'))
        inputFile.set(outputRoot.get().file("${language.get()}/xhtml5/_index.html"))
        outputFile.set(outputRoot.get().file("${language.get()}/xhtml5/toc.xml"))
        dependsOn(docbookHtml)
    }

    def whcIndex = tasks.register("whcIndex${lang.capitalize()}", StylesheetTask) {
        description 'Generate whc header and index'
        language.set(lang)
        styleSheetFile.set(styleDir.file('whc-index.xsl'))
        inputFile.set(outputRoot.get().file("${language.get()}/xhtml5/_index.html"))
        outputFile.set(outputRoot.get().file("${language.get()}/xhtml5/index.html"))
        dependsOn(docbookHtml, whcToc)
    }

    def whcHeader = tasks.register("whcHeader${lang.capitalize()}", StylesheetTask) {
        description 'Generate whc header and index'
        language.set(lang)
        styleSheetFile.set(styleDir.file('whc-header.xsl'))
        inputFile.set(outputRoot.file("${language.get()}/xhtml5/_index.xml"))
        outputFile.set(outputRoot.get().file("${language.get()}/xhtml5/_header.xhtml"))
        dependsOn(docbookHtml)
    }

    def htmlTask = tasks.register("buildDocument${lang.capitalize()}", WhcTask) {
        description 'Build whc contents'
        language.set(lang)
        tocFile.set(outputRoot.get().file("${language.get()}/xhtml5/toc.xml"))
        inputFile.set(outputRoot.get().file("${language.get()}/xhtml5/index.html"))
        outputDirectory.set(outputRoot.get().dir("${language.get()}"))
        parameterList.set([
                'layout', 'simple',
                // 'user-header', "${language.get()}/xhtml5/_header.xhtml",
                '--navigation-background-color', '#FDFDFD',
                '--field-background-color', '#FDFDFD',
                '--panel-background-color', '#FDFDFD',
                'local-jquery', 'yes'
        ])
        contentFiles.set(fileTree(dir: "${outputRoot.get()}/${language.get()}/xhtml5", include: '*.html', exclude: '_*'))
        dependsOn(whcHeader, whcToc, whcIndex)
        group('documentation')
    }
    manualHtmls.dependsOn htmlTask

    def zipTask= tasks.register("manualZip${lang.capitalize()}", Zip) {
        from fileTree(dir: layout.buildDirectory.file("docs/manual/${lang}"))
        exclude 'docs/manual/index.html'
        from fileTree(dir: "src/docs/${lang}", include: '**/version*.properties')
        archiveFileName = "${lang}.zip"
        destinationDirectory = file(layout.buildDirectory.dir("docs/manuals/"))
        dependsOn htmlTask
    }
    manualZips.dependsOn zipTask
}
